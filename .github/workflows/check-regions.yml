name: Check for Region Updates

on:
  schedule:
    # Run weekly on Sunday at midnight UTC
    - cron: '0 0 * * 0'
  workflow_dispatch: # Allow manual trigger

jobs:
  check-updates:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      issues: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build
        run: npm run build

      - name: Check for provider page changes
        id: check
        continue-on-error: true
        run: node scripts/check-for-updates.js

      - name: Create issue if changes detected
        if: steps.check.outcome == 'failure'
        uses: actions/github-script@v7
        with:
          script: |
            const title = 'üîÑ Cloud provider region pages have changed';
            const body = `## Automated Check Results

            The weekly check has detected changes in one or more cloud provider region pages.

            **Action Required:** Please review the provider documentation and update the region data if new regions have been added or existing ones modified.

            ### Provider Documentation Links
            - [AWS Regions](https://aws.amazon.com/about-aws/global-infrastructure/regions_az/)
            - [Azure Regions](https://learn.microsoft.com/en-us/azure/reliability/regions-list)
            - [GCP Regions](https://cloud.google.com/about/locations)
            - [OCI Regions](https://www.oracle.com/cloud/public-cloud-regions/)
            - [DigitalOcean Regions](https://docs.digitalocean.com/platform/regional-availability/)

            ### Steps to Update
            1. Review each provider's documentation
            2. Update the appropriate \`src/data/regions-*.ts\` file
            3. Update \`src/data/metadata.ts\` with new date
            4. Run \`npm run build && npm run export-data\`
            5. Commit and push changes

            ---
            *This issue was automatically created by the region check workflow.*
            `;

            // Check if a similar issue already exists
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'region-update'
            });

            if (issues.data.length === 0) {
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: title,
                body: body,
                labels: ['region-update', 'automated']
              });
              console.log('Issue created successfully');
            } else {
              console.log('Issue already exists, skipping creation');
            }

      - name: Summary
        run: |
          if [ "${{ steps.check.outcome }}" == "failure" ]; then
            echo "‚ö†Ô∏è Changes detected in provider pages. Issue created (if not already open)."
          else
            echo "‚úì No changes detected in provider pages."
          fi
